<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>AuShop</title>

  <!-- Bootstrap core CSS -->
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <!-- <link href="css/shop-homepage.css" rel="stylesheet"> -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css" integrity="sha384â€“5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz" crossorigin="anonymous">

  <style>
    
    .far.fa-bell{
      position: absolute;
      right: 1.5em;
      bottom: 1em;
      font-size: 1.5em;
      cursor:pointer;
    }

    .fas.fa-bell{
      position: absolute;
      right: 1.5em;
      bottom: 1em;
      font-size: 1.5em;
      cursor:pointer;
    }

    #heart_icon{
      position:relative;
      right: auto;
      bottom: 0;
    }

    .fas.fa-search{
      margin-top: 0.3em;
      font-size: 1.5em;
      color: white;
      cursor:pointer;
    }

    ul li{
      margin-right: 0.5em;
    }
    
  </style>

</head>

<body>

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-info fixed-top">
    <div class="container">
      <a class="navbar-brand" href="/index.html">Au Shop</a>
      <!-- <img src="/logo/logo.png" alt=""> -->
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item active">
            <input type="text" class="form-control" placeholder="" id="searchInput">
          </li>
          <li><i class="fas fa-search" onclick="search(this)"></i></li>
          <li class="nav-item active">
            <a class="nav-link" href="/wishlist.html">Wish List&nbsp<i class="far fa-heart" id="heart_icon"></i></a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="/tracklist.html">Track List&nbsp<i class="far fa-bell" id="track_icon"></i></a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="/signin.html#sign-in">Sign In&nbsp<i class="far fa-user"></i></a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="/index.html" onclick="signOut()">Sign Out&nbsp<i class="fas fa-sign-out-alt"></i></a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-5" id="container">

    <div class="row mt-5" >
    
      <div class="card-deck" id="card">
        
      </div>

  </div>
  <!-- /.col-lg-9 -->

</div>
<!-- /.container -->

  <!-- Footer -->
  <footer class="py-4 bg-info">
    <div class="container">
      <p class="m-0 text-center text-white">Copyright &copy; Your Website 2019</p>
    </div>
    <!-- /.container -->
  </footer>

  <!-- Bootstrap core JavaScript -->
  <script src="./vendor/jquery/jquery.min.js"></script>
  <script src="./vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script>
    
    const xhr = new XMLHttpRequest();

    xhr.open("POST", '/api/1.0/user/tracklist');

    xhr.setRequestHeader("Content-Type", "application/json");

    let user_info = localStorage.getItem('user_info');

    if(!user_info){
      // window.location.assign('/signin.html');
      window.alert('Please sign in first!');
      
    }

    let token = JSON.parse(user_info).data.access_token;

    xhr.setRequestHeader('Authorization', 'Bearer '+ token);

    xhr.onreadystatechange = function() {
      if (xhr.readyState == 4 && xhr.status == 200) {
        
        let data = JSON.parse(xhr.responseText).data;

          for(let i=0; i<data.length; i++){
            let card = document.createElement("div");
            card.classList.add("col-md-3");
            card.classList.add("mt-5");

            let image = document.createElement("img");
            image.classList.add("card-img-top");
            image.src = data[i].img;

            let link = document.createElement('a');
            link.href = `/product.html?id=${data[i].id}&store=${data[i].store}`;
            link.appendChild(image);

            let cardbody = document.createElement("div");
            cardbody.classList.add("card-body");

            let title = document.createElement("h6");
            title.innerHTML = data[i].title;
            cardbody.appendChild(title);

            let price = document.createElement("h5");
            price.innerHTML = '$ '+ data[i].price;
            cardbody.appendChild(price);

            let discount = document.createElement("span");
            discount.innerHTML = 'Save $'+ data[i].discount;
            discount.style = 'color:red';
            cardbody.appendChild(discount);

            let bell = document.createElement("i");
            bell.classList.add("fas");
            bell.classList.add("far");
            bell.classList.add("fa-bell");
            bell.classList.add(`${data[i].store}-${data[i].originPrice}-${data[i].id}`);
            bell.addEventListener("click", isTrack);

            let cardList = document.getElementById("card");
            cardList.appendChild(card);
            
            card.appendChild(link);
            card.appendChild(cardbody);
            card.appendChild(bell);   
        }
        
      }
    }
    xhr.send();

    function isTrack(e) {

    let user_info = localStorage.getItem('user_info');

    if(!user_info){
      window.alert('Please sign in first!');
      return;
    }else{

        e.target.classList.toggle("fas");

        let track = e.target.classList.value.split(" ")[2];
        
        let xhr = new XMLHttpRequest();

        xhr.open("POST", "/api/1.0/tracklist");

        xhr.setRequestHeader('Content-Type', 'application/json');

        let token = JSON.parse(user_info).data.access_token;

        xhr.setRequestHeader('Authorization', 'Bearer '+ token);
        
        let trackInfo = {
            "product_id":track.split('-')[2], 
            "store":track.split('-')[0],
            "price":track.split('-')[1]
        };
        
        let track_info = JSON.parse(localStorage.getItem('track_info'));

        let product_track = track_info.find(function(item, index, array){

          return item.product_id === trackInfo.product_id && item.store === trackInfo.store;

        });
        console.log(product_track);
        if(!product_track || product_track === undefined){
          track_info.push(trackInfo)
          localStorage.setItem('track_info', JSON.stringify(track_info));
          console.log('add track cache')
          
        }else{
          track_info.splice(track_info.indexOf(product_track), 1);
          localStorage.setItem('track_info', JSON.stringify(track_info));
          console.log('delete track cache')
        }

        xhr.send(JSON.stringify(trackInfo));

        xhr.onreadystatechange = function () {
            
            let msg = JSON.parse(xhr.responseText);
       

            if(msg.data) {
              console.log(msg.data)
            }else if(msg.error){
                console.log(msg.error);
            }
        };

      }

    }

  function search(e) {
        let keyword = document.getElementById('searchInput').value
        // console.log(keyword)
        location.assign(`/search.html?keyword=${keyword}`);
    }
  </script>


</body>

</html>


