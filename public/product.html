<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>AuShop</title>

  <!-- Bootstrap core CSS -->
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <!-- <link href="css/shop-homepage.css" rel="stylesheet"> -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css" integrity="sha384â€“5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz" crossorigin="anonymous">

  <style>
    .carousel-control-next{
      width: 20px;
    }

    .carousel-control-prev{
      width: 30px; 
    }

    .far.fa-heart{
      position: absolute;
      right: 1.5em;
      bottom: 1em;
      font-size: 1.5em;
      cursor:pointer;
    }

    .fas.fa-heart{
      position: absolute;
      right: 1.5em;
      bottom: 1em;
      font-size: 1.5em;
      cursor:pointer;
    }

    #container{
      margin-top: 80px;
    }

    #container img{
      height: 22em;
      width: 22em;
    }

    #heart_icon{
      position:relative;
      right: auto;
      bottom: 0;
    }

  </style>

</head>

<body>

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-info fixed-top">
    <div class="container">
      <a class="navbar-brand" href="/index.html">Au Shop</a>
      <!-- <img src="/logo/logo.png" alt=""> -->
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item active">
            <input type="text" class="form-control" placeholder="">
            <!-- <i class="fas fa-search"></i> -->
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="/wishlist.html">Wish List&nbsp<i class="far fa-heart" id="heart_icon"></i></a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="/tracklist.html">Track List&nbsp<i class="far fa-bell" id="track_icon"></i></a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="/signin.html#sign-in">Sign In&nbsp<i class="far fa-user"></i></a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="/index.html" onclick="signOut()">Sign Out&nbsp<i class="fas fa-sign-out-alt"></i></a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-5">

    <div class="col-lg-12 mt-5">
      <div id="container"></div>
      <table class="table mt-4 mb-5">
        <thead>
          <tr>
            <th scope="col">STORE</th>
            <th scope="col">PRICE</th>
            <th scope="col"></th>
            <th scope="col"></th>

          </tr>
        </thead>
        <tbody id="table">
         
        </tbody>
      </table>

  </div>
  <!-- /.col-lg-9 -->

</div>
<!-- /.container -->

  <!-- Footer -->
  <footer class="py-4 bg-info">
    <div class="container">
      <p class="m-0 text-center text-white">Copyright &copy; Your Website 2019</p>
    </div>
    <!-- /.container -->
  </footer>

  <!-- Bootstrap core JavaScript -->
  <script src="./vendor/jquery/jquery.min.js"></script>
  <script src="./vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get("id");
    const store = urlParams.get("store");
    const url = `/api/1.0/products/details?id=${productId}&store=${store}`;
    // const container = document.querySelector(".wishTable");
    const xhr = new XMLHttpRequest();
    xhr.open("GET", url, true);

    xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

    xhr.onreadystatechange = function() {
      if (xhr.readyState == 4 && xhr.status == 200) {
        
        let data = JSON.parse(xhr.responseText).data;

        let user_info = localStorage.getItem('user_info');
        
        
        let track_info,tracklist;
        if(localStorage.getItem('track_info') === undefined){
          tracklist = [];
          localStorage.setItem('track_info',tracklist);
        }else{
          track_info = localStorage.getItem('track_info');
          tracklist = JSON.parse(track_info);
        }
        

        let image = document.createElement("img");
        image.classList.add("mb-3");
        image.src = data[0].img;

        let title = document.createElement("h4");
        title.innerHTML = data[0].title;
        
        let container = document.getElementById("container");
        container.appendChild(image);
        container.appendChild(title);

        for (let i = 0; i < data.length; i++) {

          let tr = document.createElement("tr");
          
          let store = document.createElement("td");
          
          let link = document.createElement("a");
          if(data[i].store === 'chemistwarehouse'){
            link.href = 'https://www.'+data[i].link;
          }else{
            link.href = data[i].link;
          }
          link.innerHTML = data[i].store;
          store.appendChild(link);
          tr.appendChild(store);

          let price = document.createElement("td");
          price.innerHTML = '$'+data[i].price;
          tr.appendChild(price);

          let calendar = document.createElement("td");
          calendar.innerHTML = '<i class="far fa-calendar-alt"></i>';
          tr.appendChild(calendar);

          let bell = document.createElement("td");

          if(tracklist.length >0){
            let product_track = tracklist.find(function(item, index, array){
                return item.product_id === data[i].id && item.store === data[i].store;
              });

            let heart = document.createElement("i");
            if(!product_track){
              bell.innerHTML = '<i class="far fa-bell"></i>';
              console.log('not track')
            }else{
              bell.innerHTML = '<i class="far fa-bell fas"></i>';
              console.log('track')
            }
            
          }else{
            bell.innerHTML = '<i class="far fa-bell"></i>';
          }
          bell.classList.add(`${data[i].store}-${data[i].originPrice}-${data[i].id}`);
          bell.addEventListener("click", isTrack);
          tr.appendChild(bell);
          
          let table = document.getElementById("table");
          table.appendChild(tr);
   
        }
        
      }
    }
    xhr.send();

    function isTrack(e) {

      let user_info = localStorage.getItem('user_info');

      if(!user_info){
        window.alert('Please sign in first!');
        return;
      }else{

        
        e.target.classList.toggle("fas");

        let track = e.target.parentNode.classList.value;
        
        let xhr = new XMLHttpRequest();

        xhr.open("POST", "/api/1.0/tracklist");

        xhr.setRequestHeader('Content-Type', 'application/json');

        let token = JSON.parse(user_info).data.access_token;
        xhr.setRequestHeader('Authorization', 'Bearer '+ token);
        
        // const tracklist = (localStorage.getItem('track_info')) ? JSON.parse(localStorage.getItem('track_info')):{
        //   track_info: []
        // };

        let trackInfo = {
            "product_id":track.split('-')[2], 
            "store":track.split('-')[0],
            "price":track.split('-')[1]
        };

        if(localStorage.getItem('track_info')){
          let track_info = JSON.parse(localStorage.getItem('track_info'));

          let product_track = track_info.find(function(item, index, array){

            return item.product_id === trackInfo.product_id && item.store === trackInfo.store;

          });
          console.log(product_track)
          
          if(!product_track||product_track === undefined){

            track_info.push(trackInfo)
            localStorage.setItem('track_info', JSON.stringify(track_info));
            console.log('add track cache')

          }else{
            track_info.splice(track_info.indexOf(product_track), 1);
            localStorage.setItem('track_info', JSON.stringify(track_info));
            console.log('delete track cache')
          }

        }else{
          let track_info = [];
          track_info.push(trackInfo);
          localStorage.setItem('track_info', JSON.stringify(track_info));
        };

        xhr.send(JSON.stringify(trackInfo));

        xhr.onreadystatechange = function () {
            
            let msg = JSON.parse(xhr.responseText);
            // console.log(JSON.parse(msg));

            if(msg.data) {
              console.log(msg.data)
            }else if(msg.error){
                console.log(msg.error);
            }
        };

      }

    }

    // function isTrack(e) {

    //   let user_info = localStorage.getItem('user_info');

    //   if(!user_info){
    //     window.alert('Please sign in first!');
    //     return;
    //   }else{

        
    //     e.target.classList.toggle("fas");

    //     let track = e.target.parentNode.classList.value;
        
    //     let xhr = new XMLHttpRequest();

    //     xhr.open("POST", "/api/1.0/tracklist");

    //     xhr.setRequestHeader('Content-Type', 'application/json');

    //     let token = JSON.parse(user_info).data.access_token;

    //     xhr.setRequestHeader('Authorization', 'Bearer '+ token);
        
    //     let trackInfo = {
    //         "product_id":track.split('-')[2], 
    //         "store":track.split('-')[0],
    //         "price":track.split('-')[1]
    //     };
    //     // console.log(wishInfo)
    //     xhr.send(JSON.stringify(trackInfo));

    //     xhr.onreadystatechange = function () {
            
    //         let msg = JSON.parse(xhr.responseText);
    //         // console.log(JSON.parse(msg));

    //         if(msg.data) {
    //           console.log(msg.data)
    //         }else if(msg.error){
    //             console.log(msg.error);
    //         }
    //     };

    //   }

    // }

  </script>


</body>

</html>


